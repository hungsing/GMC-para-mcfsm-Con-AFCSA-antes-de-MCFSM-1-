%!TEX root = ./main.tex

\section{Composición de Componentes Asincrónicas}
\label{composicion}
Como ya hemos mencionado, en SOC (Service-Oriented Computing) los sistemas son concebidos como objetos dinámicos construidos en \emph{run-time} en la medida que su ejecución llega a un estado en el que la intervención de servicios externos se hace necesaria. Es decir un sistema de este tipo utilizará distintos servicios según las necesidades que se manifiesten a lo largo de una ejecución particular. 
 
Una aplicación que se encuentra ejecutando se conecta con los servicios que le son necesarios a través de canales de comunicación por los cuales se envían o reciben mensajes. Estos canales pueden establecer una comunicación entre un número fijo (para cada canal particular) pero no acotado a priori de servicios. En la sección anterior hemos detallado un conjunto de propiedades que garantizan una comunicación sin errores a través de estos canales (i.e. ausencia de deadlock, ausencia de mensajes huérfanos y ausencia de situaciones en las que el receptor no se encuentra a la espera de un mensaje que le fue enviado) y un procedimiento para garantizarlas. Estas condiciones y su procedimiento de análisis parten de la hipótesis de que las CFSMs correspondientes a todos y cada uno de los participantes de la comunicación sobre dicho canal se encuentran disponibles.

Ahora bien, que la aplicación arribe a un estado en el que un servicio se hace necesario sobre un canal particular, no implica que todos los participantes también lo sean en ese mismo instante y por ello, con el objeto de profundizar esta concepción incremental, a demanda, que se tiene sobre los sistemas de software surge, más o menos naturalmente, la idea de poder dotar al \emph{middleware} de la capacidad de realizar un \emph{binding} parcial sobre los canales. A esta práctica la llamaremos \emph{binding incremental}.
 
Esta percepción parcial del \emph{binding} sobre un canal requiere la utilización de un un lenguaje de descripción que soporten dichos mecanismos de composición. Por ejemplo, al componer dos CFSMs puede ocurrir que cada máquina se comunique a través de un canal con un tercer participante, estos dos canales son independientes y, además, una vez que se ha realizado la composición, deben ser percibidos por este tercer participante como canales de comunicación separados. Por lo tanto, para preservar la semántica de la comunicación, es necesario que el CFSM resultante de la composición tenga dos canales con este tercer participante. Este fenómeno será el eje rector de las modificaciones que introduciremos en esta sección. Esta característica no solo será necesario a nivel de CFSM (interfaz de comunicación de un servicio) sino también de los autómatas que caracterizan el cómputo, cuya interfaz de comunicación es expresada a través de una CFSM.

Para modelar este comportamiento introducimos los Autómatas Finitos de Comunicación Asincrónica (AFCA). Estos autómatas tienen tres tipos de transiciones: 
\begin{inparaenum}[1)]
\item internas, que sirven el propósito de representar cómputo realizado por la componente; 
\item de buffer, que representan comunicación asincrónica interna entre elementos de la componente, y que permiten representar la comunicación entre dos participantes luego de una composición; y por último 
\item de entrada / salida, que modelan acciones de comunicación con otras componentes del sistema.
\end{inparaenum} \\
Esta sección va a estar enfocada en la definición de composición total de autómatas y la noción de que dado un conjunto $\{ \mathcal{A}_i\}_{i \in I}$ de AFCA weak deterministic sin transiciones de buffer la semántica de la composición es equivalente a la del conjunto de mCFSM proyectadas de los elementos de $\{ \mathcal{A}_i\}_{i \in I}$. 

\begin{figure}[ht]
%\begin{center}
\xymatrix{   
	\{\mathcal{A}_i\}_{i \in I} \ar[rrr]_{\Pi} \ar[d]_{||} & & & \{C_i\}_{i \in I}  \ar[d]_{semantica}  \\
	  {A} \ar[r]_{\Pi'} \ar[d]_{\Pi} & \mathcal{L}' & = & {\mathcal{L}}  \\
	  \emptyset
}     
%\end{center}
\caption{La composición de componentes asincrónicas preserva la semántica asincrónica de su interfaz de comunicación.}
\label{fig:preservacion}
\end{figure}

Como la idea es que los autómatas con comunicación asincrónica representen procesos, o servicios, que pueden formar parte de un sistema más grande, necesitamos definir la operación de composición. Para que un par de autómatas $E$ y $R$ sean plausibles de ser compuestos se deben satisfacer las siguientes condiciones:
 \begin{enumerate}
\item $\Sigma_{E Int} \cap \Sigma_{R Int} = \emptyset$ el conjunto de etiquetas internas debe ser disjunto. 
\item $ B_E \cap B_R = \emptyset$ el conjunto de Buffers de ambos autómatas debe ser disjunto  
\end{enumerate}
\begin{definition}[Composición]\label{def:comp}
Dados $\mathcal{P}$ un conjunto de participantes y $\mathcal{M}$ un conjunto de mensajes. Denominamos al conjunto de autómatas participantes como $E_\mathcal{P} = \{E_{p_i} \ | p_i \in \mathcal{P}\}$, dónde $E_{p_i}= \langle Q_{p_i}, B_{p_i}, \mathcal{C}_{p_i}. \Sigma_{p_i}, \delta_{p_i}, q_{0{p_i}}, F_{p_i} \rangle$. Dado un conjunto de autómatas se exige que todo par de integrantes sean compatibles (i.e. se satisface que para todos $p_i, p_j \in \mathcal{P}$, $\Sigma_{p_i} \cap \Sigma_{p_j}= \emptyset$ y $B_{p_i} \cap B_{p_j} = \emptyset$). Luego, definimos la composición $E_\mathcal{P} = ||_{1..n} E_{p_i}$ como sigue:
\begin{itemize}
    \item $Q_\mathcal{P}= \Pi_{p_i \in \mathcal{P}} Q_{p_i}$ (i.e. el conjunto de estados de la composición es el producto cartesiano de los estados de los autómatas componentes),    
    \item $B_\mathcal{P} = \bigcup_{p_i \in \mathcal{P}} B_{p_i} \cup \{ \omega_c \ | \ \mbox{there exists } p_i, p_j \in \mathcal{P} \mbox{ such that } c \in \mathcal{C}_{p_i} \cap \mathcal{C}_{p_j} \}$ (i.e. el conjunto de nombres de buffers del autómata resultante se compone de los buffers de cada autómata participante en la composición, junto con uno nuevo por cada canal compartido entre cada par de autómatas, dichos canales son aquellos mediante los cuales los autómatas a componer intercambian mensajes),    
    \item $\mathcal{C}_\mathcal{P} = \bigcup_{p_i \in \mathcal{P}} \mathcal{C}_{p_i} \setminus \{ c_k \ | \mbox{for all } p_i, p_j \in \mathcal{P}, c \in \mathcal{C}_{p_i} \cap \mathcal{C}_{p_j} \}$,    
    \item $\Sigma_\mathcal{P} = \Sigma_{\mathcal{P}\mathit{Int}} \cup  \Sigma_{\mathcal{P}\mathit{Ex}} \cup \Sigma_{\mathcal{P}\mathit{Buff}}$ tal que:    
    \begin{inparaenum}[1)]
        \item $\Sigma_{\mathcal{P}\mathit{Int}} = \bigcup_{p_i \in \mathcal{P}} \Sigma_{p_i\mathit{Int}}$,
        \item $\Sigma_{\mathcal{P}\mathit{Ex}} = \bigcup_{p_i \in \mathcal{P}} \Sigma_{p_i\mathit{Ex}} \setminus \Sigma_{p_i \mapsto p_j}$ y 
        \item $\Sigma_{\mathcal{P}\mathit{Buff}} = \bigcup_{p_i \in \mathcal{P}} \Sigma_{p_i\mathit{Buff}} \cup \Sigma_{p_i \mapsto p_j}$,
    \end{inparaenum}
donde $\Sigma_\mathit{p_i \mapsto p_j} =\{ \langle p_i,p_j,c \rangle \ | \ p_i, p_j \in \mathcal{P}, \  c \in \mathcal{C}_{p_i} \cap \mathcal{C}_{p_j}\}$
\item $\delta_{\mathcal{P}} = \delta_{\mathcal{P}\mathit{Int}} \cup \delta_{\mathcal{P}\mathit{Ex}} \cup \delta_{\mathcal{P}\mathit{Buff}}$ tal que:
\begin{enumerate}
\item $\delta_{\mathcal{P}\mathit{Int}} \subseteq Q_{\mathcal{P}} \times \Sigma_{\mathcal{P} Int} \times Q_{\mathcal{P}}$  es la relación de transición interna, tal que que se satisface la siguiente fórmula:
$$(\forall \langle q, \sigma, q' \rangle \in \delta_{\mathcal{P}\mathit{Int}})(\exists p_i \in \mathcal{P})(\exists q_{p_i}, q'_{p_i} \in Q_{p_i}, \sigma \in \Sigma_{p_i})(\langle q_{p_i}, \sigma, q'_{p_i} \rangle \in \delta_{p_i Int})$$

\item $\delta_{\mathcal{P}\mathit{Ex}} \subseteq Q_{\mathcal{P}} \times \Sigma_{\mathcal{P}\mathit{Ex}} \times Q_{\mathcal{P}}$ es la relación de transición externa, tal que que se satisface la siguiente fórmula: $$(\forall \langle q, \sigma, q' \rangle \in \delta_{\mathcal{P}\mathit{Ex}}) (\exists p_i \in \mathcal{P})(\exists q_{p_i},q'_{p_i} \in Q_{p_i}, \sigma \in \Sigma_{p_i}) (\langle q_{p_i},\sigma,q'_{p_i} \rangle \in \delta_{p_i Ex})$$

\item $\delta_{\mathcal{P}\mathit{Buff}} \subseteq Q_{\mathcal{P}} \times \Sigma_{\mathcal{P} \mathit{Buff}} \times Q_{\mathcal{P}}$ es la relación de transición por comunicación asincrónica interna tal que se satisface la siguiente fórmula:
$$
\begin{array}{l}
\langle q, \sigma, q' \rangle \in \delta_{\mathcal{P}\mathit{Buff}} \mbox{ sii } (q = \langle q_k \rangle_{p_k \in \mathcal{P}} \land q' = \langle q'_{k'} \rangle_{p_{k'} \in \mathcal{P}} \land\\
\qquad
\begin{array}{l}
((\exists p_i \in \mathcal{P})((\forall p_k \in \mathcal{P})(p_k \neq p_i \implies q_k = q'_k) \land \\
\qquad(\exists \omega_b \in B_{p_i}, \omega_b \{\gg, \ll\} m \in \Sigma_{{p_i} \mathit{Buff}})(\langle q_i, \omega_b \{\gg, \ll\} m, q'_i \rangle \in \delta_{p_i \mathit{Buff}}) \land\\
\qquad\qquad \sigma = \omega_b \{\gg, \ll\} m)\lor\\
(\exists p_i, p_j \in \mathcal{P})(p_i \neq p_j \land (\forall p_k \in \mathcal{P})((p_k \neq p_i \land p_k \neq p_j) \implies q_k = q'_k) \land \\ 
\qquad ((\exists \mathit{Out}(c_{{p_i, p_j}_n}, m) \in \Sigma_{{p_i} \mathit{Ex}})(\langle q_i, \mathit{Out}(c_{{p_i, p_j}_n}, m), q'_i \rangle \in \delta_{p_i  \mathit{Ex}} \land\\
\qquad\qquad \sigma = \omega_{c_{{p_i p_j}_n}} \ll m) \lor \\ 
\qquad (\exists \mathit{In}(c_{p_j,{p_i}_n}, m) \in \Sigma_{{p_i} \mathit{Ex}})(\langle q_i, \mathit{In}(c_{p_j,{p_i}_n}, m), q'_i \rangle \in \delta_{p_i \mathit{Ex}} \land\\
\qquad\qquad \sigma = \omega_{c_{p_j,{p_i}_n}} \gg m))))
\end{array}
\end{array}
 $$
 
Además vale que $\forall q_i,q_j \in Q_\mathit{\mathcal{P}}, \ m \in \mathcal{M} \ |	 \ \langle q_i, [\omega_\mathit{b}]_{b \in B_\mathcal{P}} \gg m, q_j \rangle$

$\langle q_i, [\omega_\mathit{b}]_{b \in B_\mathcal{P}} \gg m, q_j \rangle \in \delta_\mathit{\mathcal{P}Buff} \iff \exists q'_i, q'_j \in Q_\mathit{\mathcal{P}}$ tal que $\ \langle q'_i, [\omega_\mathit{b}]_{b \in B_\mathcal{P}} \ll m, q'_j \rangle \in \delta_\mathit{\mathcal{P}Buff}$ y se cumple una de las siguientes condiciones:
\begin{enumerate}
\item $q'_j = q_i$ 
\item $\exists \sigma \in \Sigma_\mathit{\mathcal{P}}$ tal que $\langle q'_j, \sigma, q_i \rangle \in \delta_\mathit{\mathcal{P}} \land \sigma \neq [\omega_\mathit{b}]_{b \in B_\mathcal{P}} \gg m $
\item $\exists s=[q'_j,...,q_i] $ donde s es una secuencia finita de estados tales que $s[0]= q'_j, s[n-1]=q_i$ y sea $ 0 \ll x \ll$ n-1,$s[x] \in Q_\mathit{\mathcal{P}}$ y $\forall s[x], s[x+1], \exists \sigma \in \Sigma_\mathit{\mathcal{P}} \land \langle s[x], \sigma, s[x+1] \rangle \in \delta_\mathit{\mathcal{P}} $  
\end{enumerate} 
\end{enumerate}
\item $q_0 = \langle {q_0}_{p_1}, \ldots, {q_0}_{p_n} \rangle$, y
\item $F_{\mathcal{P}} = \bigcup_{1..n} F_{p_i}$.
\end{itemize}
\end{definition}


Cada autómata es un sistema independiente que cumple una función (o una serie de funciones), y se relaciona con otros a través del envío de mensajes. Para asegurarnos esto pedimos que para todo par de autómatas a componerse tengan conjuntos de etiquetas de acciones que sean disjuntos. 

Del mismo modo, cada autómata tiene su propio conjunto de buffers que pedimos sean disjuntos, para distinguir la comunicación interna de cada autómata componente de la que ocurra entre componentes o con participantes externos. Para modelar la comunicación interna entre componentes, agregamos dos buffers por cada par de integrantes, uno para cada sentido de la comunicación, de $E_{p_i}$ a $E_{p_j}$ y viceversa.

Como los conjuntos de acciones son disjuntos podemos decir que las acciones internas, de comunicación externa y de buffer, de cada componente se preservan, siempre y cuando tenga sentido con la composición de estados. Existe un caso particular que ocurre cuando existían envíos de mensaje de un autómata componente a otro. En ese caso dado que ambos ahora son parte un mismo autómata, la comunicación pasa a ser envío de mensajes interno. Para representar este tipo de comunicación es que utilizamos buffers. De este modo el intercambio que antes era $\mathit{In} (c_{p_i, p_{j_n}},m)$ y $\mathit{Out}(c_{p_j, p_{i_n}},m)$ ahora es $\omega_{c_{p_i p_{j_n}}}  \ll m$ y $b_{c_{p_j, p_{i_n}}}  \gg  m$, donde $ \omega_{c_{p_i, p_{j_n}}}, \omega_{c_{p_j, p_{i_n}}} in \mathcal{C}_{\mathcal{P}} $ son los buffers exclusivos del autómata compuesto. 

Al componer autómatas la comunicación que antes era externa y ahora es de buffer puede generar problemas. Puntualmente pueden aparecer transiciones de consumo de un buffer (que antes eran envío de mensajes) donde antes no había. De este modo pueden aparecer secuencias de estados y transiciones donde se consume un mensaje antes de que este sea depositado en el buffer correspondiente. Para esto pedimos que $\delta_\mathit{\mathcal{P}Buff}$ cumpla con una condición especial. Solo pueden haber transiciones de consumo saliendo de un estado si en alguna secuencia de acciones que termina en ese estado, hay transiciones de producción (es decir se encola un mensaje en el buffer).

\begin{figure}
\begin{example}[Composición de Autómatas Finitos de Comunicación Asincrónica]
\label{ex:Composicion}
Considere los siguientes AFCA:
\begin{itemize}
    \item $S= \langle \{q_0,..,q_4\},[b_0],\{sr_1,rs_1\}, \Sigma_S, \delta_S, q_0, \{q_4\} \rangle$, con $\Sigma_S =\{wait, b_0 \ll m_1,b_0 \gg m_1, In(rs_1,b), Out(sr_1,c) \}$
    \item $R=\langle \{q_0,q_1,q_2\},[],\{sr_1,rs_1\}, \Sigma_R, \delta_R, q_0, \{q_4\} \rangle$, con $\Sigma_R = \{Out(rs_1,b), In(sr_1,c)\}$, y su composición
    \item $\RS =\langle Q_{RS}, [b_0, sr_1, rs_1], \Sigma_{RS}, \delta_{RS}, q_{00}, \{q_{42}\} \rangle$, con $\Sigma_{RS} =\{wait, b_0 \ll m_1,b_0 \gg m_1, rs_1 \ll b, rs_1 \gg b, sr_1 \ll c, sr_1 \gg c) \}$
\end{itemize} 

\begin{tikzpicture}[->, thick][scale=0.33]
 \node[state,initial] (q_0)   {$q_0$}; 
 \node[state] (q_1) [right= 1.5cm of q_0 ] {$q_1$};
 \node[state] (q_2) [right = 1.5 of q_1 ] {$q_2$};
 \node[state] (q_3) [below=  of q_1 ] {$q_3$};
 \node[state,accepting] (q_4) [left= 2cm of q_3 ] {$q_4$};
 \draw[]        
        (q_0) edge[above] node{$In(rs_1,b)$} (q_1)
        (q_1) edge[above] node{$b_0 \ll m_1$} (q_2)
        (q_1) edge[left] node{$wait$} (q_3)
        (q_2) edge[right] node{$\ b_0 \gg m_1$} (q_3)
        (q_3) edge[above] node{$Out(sr_1,c)$} (q_4)
        ;
\end{tikzpicture}
%\caption{S}
\ 
\begin{tikzpicture}[->, thick][scale=0.33]
 \node[state,initial] (q_0)   {$q_0$}; 
 \node[state] (q_1) [below= of q_0 ] {$q_1$};
  \node[state,accepting] (q_2) [below= of q_1] {$q_2$};
 \draw[]        
        (q_0) edge[right] node{$Out(rs_1,b)$} (q_1)
        (q_1) edge[right] node{$In(sr_1,c)$} (q_2)
        ;
\end{tikzpicture} 
\\
\begin{tikzpicture}[->, thick][scale=0.33]
 \node[state,initial] (q_00)   {$q_{00}$}; 
  \node[state] (q_01) [right= 1.8cm of q_00 ] {$q_{01}$};
  \node[state] (q_11) [right= 1.8cm of q_01 ] {$q_{11}$};
  \node[state] (q_21) [right= 1.8cm of q_11 ] {$q_{21}$};
  \node[state] (q_31) [below= of q_21 ] {$q_{31}$};
  \node[state] (q_41) [left= 1.8cm of q_31 ] {$q_{41}$};
  \node[state,accepting] (q_42) [left= 1.8cm of q_41] {$q_{42}$};
  \draw[]        
         (q_00) edge[above] node{$rs_1 \ll b$} (q_01)
         (q_01) edge[above] node{$rs_1 \gg b$} (q_11)
         (q_11) edge[above] node{$b_0 \ll m$} (q_21)
         (q_11) edge[right] node{$wait$} (q_31)
         (q_21) edge[right] node{$b_0 \gg m$} (q_31)
         (q_31) edge[above] node{$sr \ll c$} (q_41)
         (q_41) edge[above] node{$sr \gg c$} (q_42)
       ;
\end{tikzpicture}
\end{example}
\caption{Ejemplo de composición autómata asincrónico de comunicación}
\label{fig:ejemplo-comp}
\end{figure} 

\begin{definition}[Determinismo] Decimos que un autómata es determinístico cuando cumple que no hay dos transiciones con la misma etiqueta que partan de un mismo estado y vayan a estados distintos. Es decir: 
sea un autómata $ \Lambda = \langle Q, \Sigma, \delta, q_0, F \rangle$ se cumple
$ \forall \  q_i, q_j, q_k \in Q_{j \neq k}, \  \nexists \ \delta_i, \delta_j \in \delta, t \in \Sigma \ \| \  \delta_1 = \langle q_i, t, q_j \rangle, \ \delta_2 = \langle q_i, t, q_k \rangle$ \\

Decimos que la composición de estos autómatas preserva el determinismo. Esto es un resultado directo de que ambos autómatas no comparten acciones y de la definición de la composición de $\delta$.
\end{definition}

\begin{definition}[Weak Determinism]Un autómata $A= \langle Q, \mathcal{C}, B, \Sigma, \delta, q_0, F \rangle$ es weak determinate si para todo esado $q \in Q$ y para toda cadena $s \in \Sigma^*$ siempre que $q \xrightarrow{s} q'$ y $q \xrightarrow{s} q''$, con $q',q'' \in Q$, entonces $q' \approx q''$.

\end{definition}

\begin{definition}[Cociente por comunicación interna]
Dado un autómata $A = \langle Q, \mathcal{C}, B, \Sigma, \delta, q_0, F \rangle$, weak deterministic. Dados dos estados $q, q' \in Q$ tales que $q \xrightarrow{\sigma^*} q'$ con $\sigma \in \Sigma_{\mathit{Int}}^*$ decimos que son bisimilares $q \approx q'$. Llamamos $[q]_\mathcal{M}$ a la clase de equivalencia por comunicación interna de un estado $q$ y la definimos como $[q]_\mathcal{M}= \{q'| q \xrightarrow{\sigma^*} q'\}$. Para un estado $q$ del autómata, su clase de equivalencia por comunicación interna $[q]_\mathcal{M}$ son aquellos estados $q'$ alcanzables en cero o más pasos de transiciones internas. Decimos que dos clases de equivalencia están relacionadas $[q]_\mathcal{M} \xrightarrow{\sigma} [q']_\mathcal{M}$ sii $\exists q_i \in [q]_\mathcal{M}, q'_i \in [q']_\mathcal{M}$ tales que $\langle q_i,\sigma,q'_i \rangle \in \delta_{Buff}$
\end{definition}

\begin{definition}[Proyección de comuniación interna de AFCA]\label{def:pci}
Dado un AFCA $A = \langle Q, B, \mathcal{C}, \Sigma, \delta, q_0, F \rangle$, definimos $\Tau(\mathcal{A})$ como la proyección de la semántica de comunicación interna de $\mathcal{A}$. Llamamos $\hat{\mathcal{A}}$ al sistema de transición etiquetado resultante y decimos que $\Tau (\langle Q, B, \mathcal{C}, \Sigma, q_0, \delta, F \rangle)= \langle \hat{Q}, \hat{q_0}, \hat{\Delta} \rangle$ tal que:
\begin{itemize}
    \item $ \hat{Q} = \{ \langle q, \overrightarrow{\Omega} \rangle | q \in Q \land \overrightarrow{\Omega} = (\Omega_b)_{b \in B},$ con $\Omega_b \in \mathcal{M}^* \}$ Cada estado del sistema de transición resultante es una configuración de $\mathcal{A}$.
    \item $\hat{q_0} = \langle q, \overrightarrow{\epsilon} \rangle$, es la configuración inicial de $\mathcal{A}$.
    \item $\hat{\Delta}= \{\langle \langle q_i, \Omega \rangle, \hat{\sigma},\langle q_j, \Omega' \rangle \rangle | q_i,q_j \in Q, \hat{\sigma} \in \delta_{Buff} \land \exists \sigma \in \Sigma$ tal que  $[q_i]_\mathcal{M} \xrightarrow{\sigma} [q_j]_\mathcal{M} \}$. Definimos $\hat{\Delta}$ como la relación de transición de $\hat{\mathcal{A}}$. Un estado de $\hat{q_j}$ es alcanzable desde otro $\hat{q_i}$ si la clase de equivalencia $[q_j]_\mathcal{M}$ es alcanzable desde $[q_i]_\mathcal{M}$
    
\end{itemize}
\end{definition}

\begin{definition}[Bisimulación]
Dado un sistema de transición etiquetado $ S =\langle Q, \Sigma, \delta \rangle $, una bisimulación es una relación binaria $R \subseteq Q \times Q$, tal que tanto $R$ como su transpuesta $R^T$ son simulaciones. Equivalentemente $R$ es una bisimulación si para cada par de elementos $p, q \in Q$ vale $\langle p, q \rangle \in R$ y para todo $\sigma \in \Sigma $ vale:
\begin{itemize}
    \item $(\forall \sigma \in \Sigma \  | \  p \ \overset{\sigma}{\rightarrow} p' \implies \exists q'\in Q \ \mathit{tal que} \ q \overset{\sigma}{\rightarrow} q' \land \langle p', q' \rangle \in R )$ y, simétricamente vale 
    \item $(\forall \sigma \in \Sigma \  | \  q \overset{\sigma}{\rightarrow} q' \implies \exists p'\in Q \ \mathit{tal que} \ p \overset{\sigma}{\rightarrow} p' \land \langle p', q' \rangle \in R ) $
\end{itemize}

Dados dos estados $p, q \in Q $, p es bisimilar a q, se denota $p \sim q $, si existe una bisimulación R tal que $\langle p,q \rangle \in R$. La relación de bisimilaridad $\sim$ es una relación de equivalencia. Además es la relación de bisimulación más grande sobre un sistema dado.

\end{definition}

\begin{prop}[Equivalencia de semánticas] Sea $\{\mathcal{A_i}\}_{i \in I}$ un conjunto de weak deterministic AFCA sin transiciones de comunicación interna y $\mathcal{A}$ su composición. Llamamos $\hat{\mathcal{A}}=\langle \hat{Q}, \hat{q_0}, \hat{\delta} \rangle$ al sistema de transición etiquetado (LTS) resultante de la proyección $\Tau(\mathcal{A})$. Sea $\{C_i\}_{i \in I}$ el communicating system conformado por las mCFSM correspondientes al conjunto autómatas. Llamamos $C$ al LTS que representa la semántica de $\{C_i\}_{i \in I}$. Decimos que $\hat{\mathcal{A}}$ y $C$ son bisimilares.

\begin{proof}

\begin{itemize}
    \item[\textbf{Transiciones}]
    \item[$\implies$]Toda transición $\hat{\sigma} \in \hat{\Delta}$ representa una operación en un buffer $a_ka_j \in B_{\mathcal{A}}$ de $\mathcal{A}$. Todo buffer $a_ka_j$ es, por la definición de composición, un canal $a_ka_j \in \mathcal{C}$ entre dos autómatas componentes $\mathcal{A}_k$ y $\mathcal{A}_j$ que fue internalizado. Entonces cada transición entre dos estados de $\hat{\mathcal{A}}$ corresponde a una transición de comunicación externa entre dos autómatas componentes. Toda transición de comunicación externa está representada en una mCFSM, por lo tanto tiene una transición correspondiente en $C = \langle Q_c, q_{0C}, \Delta_C \rangle$. Entonces toda transición de $\hat{\mathcal{A}}$ tiene su transición equivalente en $C$. 

% $\forall \hat{\sigma} \in \hat{\Delta} \exists \langle q,a_ka_j{\ll,gg}m,q' \in \delta_{\mathcal{A}}$ con $a_ka_j \in B_{\mathcal{A}}$. $a_ka_j \in B_{\mathcal{A}} \iff \exists a_ka_j \in \mathcal{C}$
    \item[$\impliedby$]Toda transición de $C$ es una comunicación externa entre dos autómatas $\mathcal{A}_k, \mathcal{A}_j \in \{\mathcal{A}_i\}_{i \in I}$, por definición de communicating system. Toda comunicación externa entre un par de autómatas del conjunto es una comunicación interna de $\mathcal{A}$, y por lo tanto está representada en una transición del lts $\hat{\mathcal{A}}$. 
    \item[] Entonces $((\forall \hat{\sigma} \in \hat{\Delta}) (\exists \sigma_C \in \Delta_C)) \land ((\forall \sigma_C \in \Delta_C) (\exists \hat{\sigma} \in \hat{\Delta}))$ 
    
    \item[\textbf{Estados}] 
    \item Todo estado $\hat{q} \in \hat{Q}$ es una configuración $\langle q, \overrightarrow{\Omega} \rangle$ de $\mathcal{A}$ con $q \in Q$ y $\overrightarrow{\Omega}= (\Omega_b)_{b \in B} \land \Omega_b \in \mathcal{M}^*$. 
    
    \item[$\implies$] $\overrightarrow{\Omega}$ es la secuencia de buffers $B$ con sus respectivos contenidos en cada estado. Por la definición de composición [Def~\ref{def:comp}] $B$ contiene los buffers que eran canales de comunicación externa $(a_ka_j)_n \in \mathcal{C}_{\mathcal{A}_i}$, más los buffers propios de cada componente $b \in B_{\mathcal{A}_i}$. Por definición de $\hat{\Delta}$, un estado $\langle q', \overrightarrow{\Omega} \rangle$ es alcanzable desde otro $\langle q, \overrightarrow{\Omega} \rangle$, $(q,q' \in Q$, si existe una transición de comunicación interna $\langle q,(a_ka_j)_n \ll m ,q' \rangle \in \delta_{\mathcal{A}}$ o $\langle q,(a_ka_j)_n \ll m ,q' \rangle \in \delta_{\mathcal{A}}$. Como los autómatas de $\{\mathcal{A}_i\}_{i \in I}$ no tienen transiciones de comunicación interna, podemos afirmar que los buffers que cambian su contenido en cada estado de $\hat{\mathcal{A}}$ son únicamente los de la forma $(a_ka_j)_n$. Ya probamos que las transiciones de $\hat{A}$ son semánticamente equivalentes a las de $C$. Entonces podemos decir que los buffers que se modifican en $\hat{A}$ son los mismos canales que se modifican en $C$.
    
    \item[$\impliedby$] Para todo canal $(a_ka_j)_n \in \mathcal{C}_{\mathcal{A}_i}$ existe un buffer $(a_ka_j)_n \in \mathcal{B}_{\mathcal{A}}$. Todas las transiciones de buffer de $\mathcal{A}$ están representadas en $\hat{\mathcal{A}}$ y afectan únicamente a los buffers $(a_ka_j)_n$. Por lo tanto los canales que sufren cambios de estado a estado en $C$ son los mismos buffers afectados en $\hat{\mathcal{A}}$
    
    \item Ya vimos que para todo $\hat{\sigma} \in \hat{\Delta}$ existe una transición equivalente entre los estados de $C$ y viceversa. También vimos que los buffers representados en los estados de $\hat{\mathcal{A}}$ son los mismos canales representados en los estados de $C$. Entonces podemos decir que para todo estado $p \in \hat{Q}$ tal que $p \xrightarrow{\hat{\sigma}} p'$ entonces $\exists q \in Q_C$ tal que $q \xrightarrow{\sigma} q'$ y como $\hat{\sigma}$ y $\sigma$ son equivalentes podemos decir que $\langle p', q' \rangle \in R$ dónde R es una relación de bisimulación. 
    
    \item Simétricamente podemos decir $\forall q \in Q_C$ tal que $q \xrightarrow{\sigma} q'$ entonces $\exists p \in Q_C$ tal que $p \xrightarrow{\hat{\sigma}} p'$ y como $\hat{\sigma}$ y $\sigma$ son equivalentes podemos decir que $\langle p', q' \rangle \in R$.
    
\end{itemize}

\end{proof}
\end{prop}

\newpage

\begin{figure}[ht]
\begin{example}[Transformación de Autómatas Finitos de Comunicación Asincrónica]
\label{ex:Transformación}
Consideremos los siguientes AFCA 
\begin{center}
\begin{tikzpicture}[->, thick]
 \node[state,initial] (q_0)   {$q_0$}; 
 \node[state] (q_1) [right= 1.5cm of q_0 ] {$q_1$};
 \node[state] (q_2) [below= of q_0 ] {$q_2$};
 \node[state] (q_3) [right= 1.5cm of q_2 ] {$q_3$};
 \node[state, accepting] (q_4) [below= of q_3 ] {$q_4$};
	
 \draw[]        
        (q_0) edge[above] node{out(pr,a)} (q_1)
        (q_0) edge[left] node{in(sp,b)} (q_2)
        (q_1) edge[right] node{in(sp,b)} (q_3)
        (q_2) edge[above] node{out(pr,a)} (q_3)
        (q_3) edge[right] node{$int_p$} (q_4)
        ; 
\end{tikzpicture} 
\qquad
\begin{tikzpicture}[->, thick]
 \node[state,initial] (q_0)   {$q_0$}; 
 \node[state] (q_1) [below= of q_0 ] {$q_1$};
 \node[state, accepting] (q_2) [below= of q_1 ] {$q_2$};
 \draw[]        
        
        (q_0) edge[right] node{$int_r$} (q_1)
        (q_1) edge[right] node{in(pr,a)} (q_2)
        ;
\end{tikzpicture} 
\qquad
\begin{tikzpicture}[->, thick]
 \node[state,initial] (q_0)   {$q_0$}; 
 \node[state] (q_1) [below= of q_0 ] {$q_1$};

 \draw[]        
        
        (q_0) edge[right] node{out(sp,b)} (q_1)
        
        ;
\end{tikzpicture} 

\end{center}

El autómata compuesto resultante es el AFCA $\mathcal{A}$  \\  
\begin{tikzpicture}[->, thick]
 \node[state,initial] (q_0)   {$q_{000}$}; 
 \node[state] (q_1) [right= 1.5cm of q_0 ] {$q_{100}$};
 \node[state] (q_2) [right = 1.5 of q_1 ] {$q_{110}$};
 \node[state] (q_3) [right = 1.5 of q_2 ] {$q_{120}$};
  \node[state] (q_4) [right = 1.5 of q_3 ] {$q_{121}$};
  \node[state] (q_5) [below=  of q_0] {$q_{001}$};
  \node[state] (q_6) [right = 1.5cm of q_5] {$q_{201}$};
  \node[state] (q_7) [right = 1.5 of q_6 ] {$q_{301}$};
  \node[state] (q_8) [right = 1.5 of q_7 ] {$q_{311}$};
  \node[state] (q_9) [right = 1.5 of q_8 ] {$q_{321}$};
 \node[state,accepting] (q_10) [right= 1.5cm of q_9 ] {$q_{421}$};
 \draw[]        
        (q_0) edge[above] node{$PR \ll a$} (q_1)
        (q_1) edge[above] node{$int_r$} (q_2)
		(q_2) edge[above] node{$PR \gg a$} (q_3)
        (q_3) edge[above] node{$SP \ll b$} (q_4) 
        (q_4) edge[right] node{$SP \gg b$} (q_9)
        (q_0) edge[left] node{$SP \ll b$} (q_5)
        (q_5) edge[below] node{$SP \gg b$} (q_6)
        (q_6) edge[below] node{$PR \ll a$} (q_7)
        (q_7) edge[below] node{$int_r$} (q_8)
        (q_8) edge[below] node{$PR \gg a$} (q_9)
        (q_9) edge[below] node{$int_p$} (q_10)
        ;
\end{tikzpicture}
    \caption{Transformación}
    \label{fig:transformacion}
\end{example}
\end{figure}


\begin{figure}[h]
\begin{example}[communicating system de transformación]
\label{ex:cmst} El communicating system correspondiente al conjunto de autómatas es el siguiente
\centering

\begin{tikzpicture}[->, thick]
 \node[state,initial] (q_0)   {$q_0$}; 
 \node[state] (q_1) [right= of q_0 ] {$q_1$};
  \node[state] (q_2) [below= of q_0 ] {$q_2$};
 \node[state] (q_3) [right= of q_2 ] {$q_3$};

 \draw[]        
        (q_0) edge[above] node{pr!a} (q_1)
        (q_0) edge[right] node{sp?b} (q_2)
        (q_1) edge[right] node{sp?b} (q_3)
        (q_2) edge[above] node{pr!a} (q_3)
        ; 
\end{tikzpicture} 
\qquad
\begin{tikzpicture}[->, thick]
 \node[state,initial] (q_0)   {$q_0$}; 
 \node[state] (q_1) [below= of q_0 ] {$q_2$};

 \draw[]        
        
        (q_0) edge[right] node{pr?a} (q_1)
        
        ;
\end{tikzpicture} 
\qquad
\begin{tikzpicture}[->, thick]
 \node[state,initial] (q_0)   {$q_0$}; 
 \node[state] (q_1) [below= of q_0 ] {$q_1$};

 \draw[]        
        
        (q_0) edge[right] node{sp!b} (q_1)
        
        ;
\end{tikzpicture} 

La semántica del communicating system es el sistema de transición etiquetado $\mathcal{L}$
\\
\begin{tikzpicture}[->, thick][scale=0.20]
 \node[state,initial] (q_0)   {$q_{000},\epsilon,\epsilon$}; 
 \node[state] (q_1) [right= 3cm of q_0 ] {$q_{100},a, \epsilon$};
 \node[state] (q_2) [right = 3cm of q_1 ] {$q_{120},\epsilon, \epsilon$};
 \node[state] (q_3) [below = of q_2 ] {$q_{121}, \epsilon,b$};
 \node[state,accepting] (q_4) [below=  of q_3] {$q_{321}, \epsilon,\epsilon$};
 \node[state] (q_5) [below = of q_0] {$q_{001}, \epsilon, b$};
 \node[state] (q_6) [below = of q_5 ] {$q_{201}, \epsilon, \epsilon$};
 \node[state] (q_7) [right= 3cm of q_6 ] {$q_{301}, a, \epsilon$};
 \draw[]        
        (q_0) edge[above] node{$\langle q_{0p},PR!a,q_{1p} \rangle$} (q_1)
        (q_1) edge[above] node{$\langle q_{0r},PR?a,q_{1r} \rangle$} (q_2)
        (q_2) edge[right] node{$\langle q_{0s},SP!b,q_{1s} \rangle$} (q_3)
        (q_3) edge[right] node{$\langle q_{1p},SP?b,q_{3p} \rangle$} (q_4)
        (q_0) edge[left] node{$\langle q_{0s},SP!b,q_{1s} \rangle$} (q_5)
        (q_5) edge[left] node{$\langle q_{0p},SP?b,q_{2p} \rangle$} (q_6)
        (q_6) edge[below] node{$\langle q_{2p},PR!a,q_{3p} \rangle$} (q_7)
        (q_7) edge[below] node{$\langle q_{0r},PR?a,q_{1r} \rangle$} (q_4)
        ;
\end{tikzpicture}
    \caption{Transformación}
    \label{fig:semántica mcfsm}
\end{example}
\end{figure}

\begin{figure}[ht]
    \begin{centering}
      \begin{tikzpicture}[->, thick]
         \node[state,initial] (q_0) {$[q_{000}],\epsilon, \epsilon$}; 
         \node[state] (q_1) [right= 3.5cm of q_0 ] {$[q_{100}], a, \epsilon$};
         \node[state] (q_2) [right = 3.5cm of q_1 ] {$[q_{120}],\epsilon,\epsilon$};
         \node[state] (q_3) [below= of q_2 ] {$[q_{121}],\epsilon, b$};
         \node[state] (q_4) [below=  of q_0] {$[q_{001}],\epsilon, b$};
         \node[state] (q_5) [below = of q_4] {$[q_{201}],\epsilon, \epsilon$};
         \node[state] (q_6) [right = 3.5cm of q_5 ] {$[q_{301}], a, \epsilon$};
         \node[state,accepting] (q_7) [below = of q_3 ] {$[q_{321}],\epsilon, \epsilon$};
    \draw[]        
         (q_0) edge[above] node{$\langle q_{000}, PR \ll a, q_{100} \rangle$} (q_1)
    	 (q_1) edge[above] node{$\langle q_{110}, PR \gg a, q_{120} \rangle$} (q_2)
         (q_2) edge[right] node{$\langle q_{120}, SP \ll b, q_{121} \rangle$} (q_3) 
         (q_3) edge[right] node{$\langle q_{121}, SP \gg b, q_{321} \rangle$} (q_7)
         (q_0) edge[left] node{$\langle q_{000}, SP \ll b, q_{001} \rangle$} (q_4)
         (q_4) edge[left] node{$\langle q_{001}, SP \gg b, q_{201} \rangle$} (q_5)
         (q_5) edge[below] node{$\langle q_{201}, SP \gg b, q_{301} \rangle$} (q_6)
        (q_6) edge[below] node{$\langle q_{311}, PR \ll a, q_{321} \rangle$} (q_7)
         ;
        \end{tikzpicture}
    \caption{Caption}
    \label{fig: transformación loca}
 \end{centering}
\end{figure}

\newpage
\subsection{Composición parcial vs composición total}

En esta sección definimos los Autómatas Finitos de Comunicación Asincrónica para modelar la composición parcial de CFSMs. Ahora necesitamos demostrar que esta composición parcial es equivalente a una composición total.

Como sabemos que todas las CFSMs a componer se encuentran en $\mathcal{P}$ podemos decir que conocemos a priori todos los componentes de la composición final. Dado un conjunto finito $\mathcal{P}$ de CFSMs denominamos $ p_1, p_2, p_3, \ldots, p_n$. 

Si componemos $p_1$ y $p_2$ nos quedaría el conjunto $\mathcal{P}_1 =\{ p_{12} \}, p_3, \ldots, p_n \} $, podemos hacer un paso siguiente componiendo $p_{n-1}$ y $p_n$. De esto obtenemos $\mathcal{P_2}_2= \{ p_{12}, p_3, \ldots, p_n-1 \} $. Podemos continuar este proceso hasta llegar a tener un único autómata. %Esto de acá capaz vuela cuando lo dibuje

Decimos que en cada paso de la composición parcial tengo una función suryectiva, pero no inyectiva que garantiza que cada punto del codominio es la composición de al menos dos puntos de la preimagen.

Llamemos TM1 y TM2 a los autómatas resultantes de la composición de todos los elementos de $\mathcal{P}$ por sucesión de composiciones parciales y por composición total respectivamente. Queremos ver que $ q \in Q_{TM1} \iff q \in Q_{TM2} $ y en ambos casos está entre los estados alcanzables. 

Queremos demostrar que
\begin{enumerate}
\item Las configuraciones alcanzables entre tm1 y tm2 son las mismas
\item tm1 es bisimilar a tm2, es decir que para cada configuración las acciones realizables son las mismas
\end{enumerate}


